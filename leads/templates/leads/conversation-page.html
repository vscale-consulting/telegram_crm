{% extends 'base.html' %}
{% load static %}
{% load crispy_forms_tags %}

{% block title %}
    Conversation with {{ lead.lead.username }}
{% endblock %}

{% block css %}
    <link rel="stylesheet" href="{% static 'css/chat.css' %}">
{% endblock %}

{% block body %}
<input type="hidden" id="currentLead" name="dontknow" value="{{ lead.pk }}">

    <div class="container">
        <div class="mt-3">
            <a href="{% url 'lead-list' %}"
               class="backBtn">Go Back</a>
        </div>
        <h4>Phone Number Used: {{ lead.session_used.phone_num }}</h4>
        <div id="tab3" class="tryingtoscroll"  >
            <div class="chatbox scrollbar-hidden" id="thisscrolls">
                {% comment %} <div class='tryingtoscroll'> {% endcomment %}
                <div id='thisischat'>
                    <input type="hidden" id="myScroll" name="dontknowscroll" value="{{ scroll }}">
                    {% for message in messages %}
                        {% if message.out %}
                            <p id="botStarterMessage" class="userText"><span>{{ message.message }}<span
                                    class='timeValue'>{{ message.datetime.time }}</span></span></p>
                            {% comment %} <p><span class='timeValue'>{{ message.datetime }}</span></p> {% endcomment %}
                        {% else %}
                            <p id="botStarterMessage" class='botText'><span>{{ message.message }}<span
                                    class='timeValue'>{{ message.datetime.time }}</span></span></p>

                        {% endif %}
                    {% endfor %}
                </div>
            </div>


            <div>
                <div class="d-flex">
                    <form id="message_send_form" class='m-auto' method="POST">
                        {% csrf_token %}
                        <input id='inputMsg' name="message" placeholder="Write a Message" required/>
                        <button id="mybutton" class="sendBtn">Send</button>
                    </form>
                </div>
            </div>
            <div>
            <form id='jsform' method="post">
                    {% csrf_token %}
                    <select name="category-{{ lead.lead.username }}" onchange="submit()">
                        {% if lead.category == None %}
                            <option value="none" selected disabled hidden>
                                Select an Option
                            </option>
                            <option value="Talking">Talking</option>
                            <option value="Not Replied">Not Interested</option>
                            <option value="Not Replied">Completed</option>
                            <option value="Not Replied">Replied</option>
                            
                        {% else %}
                            {% if lead.category == 'Taking' %}
                                <option value="Talking" selected>Talking</option>
                            {% else %}
                                <option value="Talking">Talking</option>
                            {% endif %}
                            {% if lead.category == 'Not Replied' %}
                                <option value="Not Replied" selected>Not Interested</option>
                            {% else %}
                                <option value="Not Replied">Not Interested</option>
                            {% endif %}
                            {% if lead.category == 'Completed' %}
                                <option value="Completed" selected>Completed</option>
                            {% else %}
                                <option value="Completed">Completed</option>
                            {% endif %}
                            {% if lead.category == 'Replied' %}
                                <option value="Replied" selected>Replied</option>
                            {% else %}
                                <option value="Replied">Replied</option>
                            {% endif %}
                        {% endif %}
                    </select>							
                </form>
            </div>
        </div>

    
    </div>

    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>

    <script>
        function create_post() {

            $.ajax({
                    url : "/leads/ajax/", 
                    type : "POST",
                    data : {
                        message : $('#inputMsg').val(),
                        lead_id : $('#currentLead').val(),
                        csrfmiddlewaretoken:$('input[name=csrfmiddlewaretoken]').val()
                    },

                    success : function(json) {
                        $('#inputMsg').val('');
                        
                        setTimeout(function(){
                            $("#thisscrolls").scrollTop($("#thisscrolls")[0].scrollHeight);
                            }, 1000);

                    },
                });
            };

        $('#message_send_form').on('submit', function(event){
            event.preventDefault();
            create_post()        
        });
    
    </script>

    <script>
        $(document).ready(function () {
            setInterval(function () {
                $("#thisischat").load(window.location.href + " #thisischat");
                if ($('#myScroll').val() == 'True') {
                    $("#thisscrolls").scrollTop($("#thisscrolls")[0].scrollHeight);                                
                }
            }, 1000);
        });
    </script>




    <script type="application/javascript">
        var messageBody = document.querySelector('#thisscrolls');
        messageBody.scrollTop = messageBody.scrollHeight - messageBody.clientHeight;

    </script>

   

{% endblock %}

